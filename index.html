<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Módulo de Supervisiones – IMSS Guarderías (MVP)</title>
<style>
  :root{
    --bg:#0b0d10; --card:#151a21; --ink:#e9eef6; --muted:#a7b0be; --pri:#4cc9f0; --ok:#58d68d; --warn:#f7b731; --bad:#ff6b6b; --line:#232b36;
    --accent:#9b5de5;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;line-height:1.35}
  header{position:sticky;top:0;z-index:9;background:linear-gradient(180deg,rgba(11,13,16,.95),rgba(11,13,16,.7));backdrop-filter: blur(8px);border-bottom:1px solid var(--line)}
  .wrap{max-width:980px;margin:0 auto;padding:12px}
  h1{margin:8px 0 2px;font-size:20px}
  .sub{color:var(--muted);font-size:13px;margin-bottom:8px}
  main{padding:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin:10px 0}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .col{flex:1 1 220px;min-width:200px}
  label{display:block;font-size:12px;color:var(--muted);margin:4px 0}
  input,select,textarea,button{width:100%;border:1px solid var(--line);background:#0e131a;color:var(--ink);
    border-radius:10px;padding:10px;font-size:14px;outline:none}
  textarea{min-height:90px;resize:vertical}
  button{cursor:pointer;background:linear-gradient(180deg,#1a2230,#121826);border:1px solid #1e2735}
  button.primary{background:linear-gradient(180deg,#3a8fd6,#2362b2);border:1px solid #2b6dbf}
  button.ghost{background:transparent;border:1px dashed var(--line)}
  button.ok{background:linear-gradient(180deg,#39b980,#2a8b60);border:1px solid #2c8f65}
  button.warn{background:linear-gradient(180deg,#f7b731,#d69b29);border:1px solid #d69b29;color:#1b1200}
  button.bad{background:linear-gradient(180deg,#ff6b6b,#d94b4b);border:1px solid #d94b4b}
  .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line);color:var(--muted)}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#0e141c;border:1px solid var(--line);margin:4px 6px 0 0}
  .pill.ok{background:rgba(88,214,141,.12);border-color:rgba(88,214,141,.35);color:var(--ok)}
  .pill.warn{background:rgba(247,183,49,.12);border-color:rgba(247,183,49,.35);color:var(--warn)}
  .pill.bad{background:rgba(255,107,107,.12);border-color:rgba(255,107,107,.35);color:var(--bad)}
  .list{display:grid;gap:8px}
  .item{border:1px solid var(--line);border-radius:12px;padding:10px;background:#0e131a}
  .item h4{margin:0 0 4px}
  .muted{color:var(--muted)}
  .grid{display:grid;gap:8px}
  .grid.cols2{grid-template-columns:1fr 1fr}
  .grid.cols3{grid-template-columns:repeat(3,1fr)}
  .flex{display:flex;gap:8px;align-items:center}
  .right{margin-left:auto}
  .sep{height:1px;background:var(--line);margin:10px 0}
  .sticky-bottom{position:sticky;bottom:0;background:linear-gradient(0deg,rgba(11,13,16,.97),rgba(11,13,16,.7));backdrop-filter: blur(6px);border-top:1px solid var(--line);padding:10px;border-radius:12px}
  .small{font-size:12px}
  .danger{color:var(--bad)}
  .success{color:var(--ok)}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;background:#0e141c;border:1px solid var(--line);border-radius:6px;padding:2px 6px}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .sticky-actions{position:sticky;bottom:8px;z-index:5}
  .inline{display:inline}
  .nowrap{white-space:nowrap}
  .hidden{display:none !important}
  .center{text-align:center}
  .badge{font-size:11px;border:1px solid var(--line);border-radius:6px;padding:2px 6px;display:inline-block;color:var(--muted)}
  .hl{color:var(--pri)}
  .link{color:var(--pri);cursor:pointer}
  .selectable{user-select:all}
  .flash{animation:flash 1.6s ease-out 1}
  @keyframes flash{0%{box-shadow:0 0 0px 0 rgba(76,201,240,.9)}50%{box-shadow:0 0 0px 10px rgba(76,201,240,.15)}100%{box-shadow:0 0 0px 0 rgba(76,201,240,0)}}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Módulo de Supervisiones</h1>
    <div class="sub">IMSS Guarderías – MVP móvil sin instalación. <span class="badge">v1.15</span></div>
  </div>
</header>

<main class="wrap">

  <!-- Herramientas admin -->
  <section class="card">
    <div class="flex">
      <h3 style="margin:0">Herramientas</h3>
      <span class="small muted" style="margin-left:8px">Solo administrador</span>
      <button id="btnToggleAdmin" class="ghost right" style="width:auto">Mostrar herramientas de administrador</button>
    </div>
  </section>

  <div id="adminPanel" class="hidden">
    <section class="card">
      <h3>1) Fuente del catálogo (GitHub RAW)</h3>
      <div class="row">
        <div class="col">
          <label>URL RAW del <b>catalogo.json</b> <span class="small muted">(búscame por: <span class="kbd">RAW_CATALOGO_JSON_URL</span>)</span></label>
          <input id="catalogUrl" placeholder="Pega aquí tu URL RAW de GitHub para catalogo.json" value="RAW_CATALOGO_JSON_URL">
        </div>
        <div class="col" style="align-self:flex-end;">
          <button id="btnLoadCatalog" class="primary">Cargar catálogo</button>
        </div>
      </div>
      <div class="small muted">Si no tienes internet o el link falla, puedes importar un <b>catalogo.json</b> local: <input type="file" id="fileCatalog" accept=".json"></div>
      <div id="catalogStatus" class="small muted" style="margin-top:6px;"></div>
    </section>

    <section class="card">
      <h3>6) Conversor: Excel → JSON de catálogo</h3>
      <div class="small muted">
        Exporta tus hojas como CSV:
        <ul class="small">
          <li>
            <b>Catálogo_Textos.csv</b> (columnas flexibles):
            <div class="mono small" style="margin-top:4px">
              Base_Detalle, Detalle_V1_Label/_TituloCorto, Detalle_V1_Texto … Detalle_V10_Label/_TituloCorto, Detalle_V10_Texto<br>
              Base_Accion,  Accion_V1_Label/_TituloCorto,  Accion_V1_Texto  … Accion_V10_Label/_TituloCorto,  Accion_V10_Texto
            </div>
          </li>
          <li><b>Catálogo_Guarderías.csv</b> (Guarderia_Numero, Guarderia_Nombre, Guarderia_RazonSocial, Guarderia_CiudadEstado, Nombre_Directora)</li>
          <li><b>Asignaciones.csv</b> (Coordinadora, Guarderia_Numero)</li>
        </ul>
      </div>
      <div class="row">
        <div class="col"><label>Catálogo_Textos.csv</label><input id="csvTextos" type="file" accept=".csv"></div>
        <div class="col"><label>Catálogo_Guarderías.csv</label><input id="csvGuards" type="file" accept=".csv"></div>
        <div class="col"><label>Asignaciones.csv</label><input id="csvAsig" type="file" accept=".csv"></div>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="col"><button id="btnBuildJSON" class="ok">Generar catalogo.json</button></div>
        <div class="col" style="text-align:right"><button id="btnDownloadJSON" class="primary">Descargar catalogo.json</button></div>
      </div>
      <div class="sep"></div>
      <label>Salida (JSON)</label>
      <textarea id="outJSON" class="mono" style="min-height:200px"></textarea>
    </section>
  </div>

  <!-- Cabecera -->
  <section class="card">
    <h3>2) Iniciar/Continuar supervisión</h3>

    <div id="alertNoCatalog" class="small danger hidden" style="margin-bottom:6px;">
      No hay catálogo cargado. Abre “Herramientas” y carga tu <b>catalogo.json</b> (o restaura uno guardado).
    </div>

    <div class="row">
      <div class="col">
        <label>Buscar guardería</label>
        <input id="findGuard" placeholder="Número o nombre..." disabled>
      </div>
      <div class="col">
        <label>Elegir guardería</label>
        <select id="selGuarderia" disabled>
          <option value="">— Carga un catálogo —</option>
        </select>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label>Coordinadora (quién realiza la supervisión)</label>
        <input id="inpCoord" placeholder="Nombre de coordinadora" disabled>
      </div>
      <div class="col">
        <label>Tipo de supervisión</label>
        <select id="selTipo" disabled>
          <option value="">Elegir...</option>
          <option>Ordinaria 1</option>
          <option>Ordinaria 2</option>
          <option>Ordinaria 3</option>
          <option>Ordinaria 4</option>
          <option>Visita de verificación</option>
        </select>
      </div>
    </div>
    <div class="row">
      <div class="col"><label>Fecha y hora de inicio</label><input id="dtInicio" type="datetime-local" disabled></div>
      <div class="col"><label>Fecha y hora de fin</label><input id="dtFin" type="datetime-local" disabled></div>
    </div>
    <div class="row">
      <div class="col">
        <button id="btnGPS" class="ghost" disabled>Obtener GPS</button>
        <span id="gpsStatus" class="small muted"></span>
      </div>
      <div class="col" style="align-self:flex-end;text-align:right;">
        <button id="btnStart" class="ok" disabled>Iniciar / Continuar</button>
      </div>
    </div>
  </section>

  <!-- Filtros -->
  <section id="navSection" class="card hidden">
    <h3>3) Navegación por catálogo</h3>
    <div class="row">
      <div class="col"><label>Procedimiento</label><select id="fProced"></select></div>
      <div class="col"><label>Proceso</label><select id="fProceso"></select></div>
      <div class="col"><label>Elemento Estándar</label><select id="fEstandar"></select></div>
      <div class="col"><label>Elemento Medible</label><select id="fMedible"></select></div>
    </div>
    <div class="row">
      <div class="col">
        <label>Búsqueda rápida por número de punto</label>
        <div class="flex">
          <input id="searchPunto" placeholder="Ej. 165">
          <button id="btnIrPunto" class="primary" style="width:auto">Ir</button>
        </div>
      </div>
      <div class="col" style="align-self:flex-end;text-align:right;">
        <button id="btnAllCumple" class="warn" style="width:auto">Marcar todos como Cumple</button>
        <button id="btnFinalizarMedible" class="ok hidden" style="width:auto; margin-left:6px;">Finalizar elemento medible</button>
        <button id="btnResetSemaforos" class="ghost" style="width:auto; margin-left:6px;">Reiniciar semáforos</button>
      </div>
    </div>
    <div id="statsFiltros" class="small muted"></div>
  </section>

  <!-- Lista -->
  <section id="puntosSection" class="card hidden">
    <div class="flex">
      <h3 style="margin:0;">4) Puntos del filtro actual</h3>
      <span class="right small muted" id="countPuntos"></span>
    </div>
    <div class="list" id="listaPuntos"></div>
    <div class="sticky-actions">
      <div class="row">
        <div class="col"><div class="small muted">Cambios guardados automáticamente.</div></div>
        <div class="col" style="text-align:right"><button id="btnResumen" class="primary">Ver resumen</button></div>
      </div>
    </div>
  </section>

  <!-- Resumen -->
  <section id="resumenSection" class="card hidden">
    <h3>5) Resumen y exportación</h3>
    <div id="resumenData" class="grid"></div>
    <div class="sep"></div>
    <div class="row">
      <div class="col"><button id="btnExport" class="ok">Exportar ZIP (JSON + CSV + evidencias)</button></div>
      <div class="col right" style="text-align:right"><button id="btnShare" class="primary">Compartir (si el navegador lo permite)</button></div>
    </div>
    <div id="exportStatus" class="small muted" style="margin-top:8px;"></div>
  </section>

  <!-- Modal Punto -->
  <dialog id="dlgPunto" style="max-width:900px;width:96%;border:1px solid var(--line);border-radius:14px;background:var(--card);color:var(--ink);">
    <form method="dialog">
      <h3 id="dlgTitle" style="margin-top:6px">Editar punto</h3>
      <div id="dlgMeta" class="small muted"></div>

      <div class="grid cols2" style="margin-top:8px">
        <div>
          <label>Detalle del incumplimiento</label>
          <textarea id="dlgDetalle" placeholder="Describe el hallazgo..."></textarea>
        </div>
        <div>
          <label>Acción tomada</label>
          <textarea id="dlgAccion" placeholder="Describe la acción..."></textarea>
        </div>
      </div>

      <div class="sep"></div>

      <!-- Variantes y placeholders -->
      <div id="dlgVars" class="grid hidden">
        <div class="row">
          <div class="col">
            <label>Elegir motivo (texto corto)</label>
            <div class="flex">
              <select id="dlgMotivoSel"></select>
              <button id="btnVerMotivo" class="ghost" style="width:auto;margin-left:6px">Ver motivo</button>
            </div>
          </div>
          <div class="col">
            <label>Elegir acción (texto corto)</label>
            <div class="flex">
              <select id="dlgAccionSel"></select>
              <button id="btnVerAccion" class="ghost" style="width:auto;margin-left:6px">Ver acción</button>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>Motivo (para {motivo})</label>
            <input id="dlgMotivo" placeholder="Escribe uno nuevo si ninguna opción aplica..." />
          </div>
          <div class="col">
            <label>Acción (para {accion})</label>
            <input id="dlgAccionVar" placeholder="Escribe una acción nueva si ninguna opción aplica..." />
          </div>
        </div>

        <div class="row" style="margin-top:6px">
          <div class="col">
            <button id="btnAplicarVars" class="primary" style="width:auto">Aplicar a los textos</button>
            <button id="btnRestaurarTpl" class="ghost" style="width:auto;margin-left:6px">Restaurar original</button>
          </div>
          <div class="col small muted" style="align-self:center;text-align:right">
            Tip: “Aplicar” usa <b>siempre</b> la plantilla original (con placeholders) para que puedas cambiar de opción cuantas veces quieras.
          </div>
        </div>
      </div>

      <div class="sep"></div>
      <div class="grid">
        <div>
          <label>Evidencias (se comprimen a máx 1600px – JPEG)</label>
          <input id="dlgFile" type="file" accept="image/*" multiple capture="environment">
          <div id="dlgPrev" class="row small muted" style="margin-top:6px"></div>
        </div>
      </div>
      <div class="sep"></div>
      <div class="flex">
        <div class="small muted">Los cambios se guardan al cerrar.</div>
        <button id="dlgDelEvs" class="bad right" value="delEvs">Eliminar evidencias</button>
        <button class="primary right" value="save">Guardar</button>
        <button class="ghost right">Cerrar</button>
      </div>
    </form>
  </dialog>

  <!-- Modal Vista Previa -->
  <dialog id="dlgPreview" style="max-width:720px;width:96%;border:1px solid var(--line);border-radius:12px;background:var(--card);color:var(--ink);">
    <h3 id="pvTitle" style="margin-top:6px">Vista previa</h3>
    <div id="pvBody" class="small" style="white-space:pre-wrap;"></div>
    <div class="sep"></div>
    <div class="flex">
      <span class="small muted">Esta es solo una vista previa; usa “Aplicar a los textos” para insertarlo.</span>
      <button id="pvClose" class="ghost right">Cerrar</button>
    </div>
  </dialog>

</main>

<!-- ZIP store -->
<script>
function zipStore(files){
  const encoder = new TextEncoder();
  const LFH = 0x04034b50, CDH = 0x02014b50, EOCD = 0x06054b50;
  function u32(v){const b=new Uint8Array(4); b[0]=v&255;b[1]=v>>>8&255;b[2]=v>>>16&255;b[3]=v>>>24&255; return b;}
  function u16(v){const b=new Uint8Array(2); b[0]=v&255;b[1]=v>>>8&255; return b;}
  function cat(arr){const n=arr.reduce((s,a)=>s+a.length,0); const o=new Uint8Array(n); let p=0; for(const a of arr){o.set(a,p); p+=a.length;} return o;}
  function crcTab(){let c, t=[]; for(let n=0;n<256;n++){c=n; for(let k=0;k<8;k++) c=c&1?0xEDB88320^(c>>>1):c>>>1; t[n]=c>>>0;} return t;}
  const CRC=crcTab(); const now=new Date();
  const t=((now.getHours()<<11)|(now.getMinutes()<<5)|(Math.floor(now.getSeconds()/2)))&0xFFFF;
  const d=(((now.getFullYear()-1980)<<9)|((now.getMonth()+1)<<5)|now.getDate())&0xFFFF;
  const parts=[], central=[]; let off=0;
  function crc32(u8){let c=0^(-1); for(let i=0;i<u8.length;i++){c=(c>>>8)^CRC[(c^u8[i])&255];} return (c^(-1))>>>0;}
  for(const f of files){
    const name=encoder.encode(f.name);
    const data=f.data instanceof Uint8Array? f.data : new Uint8Array(f.data);
    const crc=crc32(data);
    const lfh=cat([u32(LFH),u16(20),u16(0),u16(0),u16(t),u16(d),u32(crc),u32(data.length),u32(data.length),u16(name.length),u16(0),name,data]);
    parts.push(lfh);
    const cdh=cat([u32(CDH),u16(20),u16(20),u16(0),u16(0),u16(t),u16(d),u32(crc),u32(data.length),u32(data.length),u16(name.length),u16(0),u16(0),u16(0),u16(0),u32(0),u32(off),name]);
    central.push(cdh);
    off+=lfh.length;
  }
  const cblob=cat(central);
  const eocd=cat([u32(EOCD),u16(0),u16(0),u16(files.length),u16(files.length),u32(cblob.length),u32(off),u16(0)]);
  return new Blob([cat([...parts,cblob,eocd])],{type:'application/zip'});
}
</script>

<!-- APP -->
<script>
/*** Estado y utils ***/
const state = {
  catalog: null,
  current: {
    guarderiaNumero: "", guarderiaNombre: "", ciudadEstado: "", directora: "",
    coordinadora: "", tipo: "", inicio: "", fin: "", gps: null, catalogoVersion: "", id: "",
  },
  respuestas: {},
  finalizadosMedible: {},
  evidCount: 0,
  shareZipBlob: null
};

const DB_NAME = 'supdb_v1'; let idb;
function idbOpen(){ return new Promise((res,rej)=>{ const req=indexedDB.open(DB_NAME,1);
  req.onupgradeneeded=e=>{ idb=e.target.result; idb.createObjectStore('session',{keyPath:'key'}); };
  req.onsuccess=e=>{ idb=e.target.result; res(); }; req.onerror=e=>rej(e.target.error); });}
function idbSet(key,val){ return new Promise((res,rej)=>{ const tx=idb.transaction('session','readwrite'); tx.objectStore('session').put({key,val}); tx.oncomplete=()=>res(); tx.onerror=e=>rej(e.target.error); });}
function idbGet(key){ return new Promise((res,rej)=>{ const tx=idb.transaction('session','readonly'); const rq=tx.objectStore('session').get(key); rq.onsuccess=()=>res(rq.result?.val); rq.onerror=e=>rej(e.target.error); });}

const $ = sel => document.querySelector(sel);
function fmt(n){ return Intl.NumberFormat('es-MX').format(n); }
function uid(n=4){ return Math.random().toString(36).slice(2,2+n).toUpperCase(); }
function todayStr(){ const d=new Date(); const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const da=String(d.getDate()).padStart(2,'0'); return `${y}${m}${da}`; }
function ensure(val,msg){ if(!val){ alert(msg); throw new Error(msg);} }
function toCSVRow(arr){ return arr.map(v=>{ if(v==null) return ''; v=String(v);
  if(v.includes('"')||v.includes(',')||v.includes('\n')) v='"'+v.replace(/"/g,'""')+'"'; return v; }).join(','); }
function downloadBlob(b,name){ const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=name; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href), 4000); }
function textFile(text,name){ downloadBlob(new Blob([text],{type:'application/json'}), name); }
function ensurePuntosVisible(){ const sec=$('#puntosSection'); if(sec.classList.contains('hidden')) sec.classList.remove('hidden'); }

function replacePlaceholders(text, vars){
  if(!text) return '';
  let out = text;
  if(vars?.motivo) out = out.replace(/\{motivo\}/gi, vars.motivo.trim());
  if(vars?.accion) out = out.replace(/\{accion\}/gi, vars.accion.trim());
  out = out.replace(/\s+\./g, '.').replace(/\s{2,}/g, ' ').trim();
  return out;
}

/*** Habilitar/Deshabilitar cabecera según catálogo ***/
function setHeaderEnabled(enabled){
  $('#findGuard').disabled = !enabled;
  $('#selGuarderia').disabled = !enabled;
  $('#inpCoord').disabled = !enabled;
  $('#selTipo').disabled = !enabled;
  $('#dtInicio').disabled = !enabled;
  $('#dtFin').disabled = !enabled;
  $('#btnGPS').disabled = !enabled;
  $('#btnStart').disabled = !enabled;
  $('#alertNoCatalog').classList.toggle('hidden', !!enabled);
}

/*** Cargar catálogo ***/
async function loadCatalogFromUrl(){
  const url = $('#catalogUrl').value.trim();
  const st = $('#catalogStatus');
  st.textContent = 'Cargando catálogo...';
  try{
    const resp = await fetch(url,{cache:'no-store'}); if(!resp.ok) throw new Error('HTTP '+resp.status);
    const json = await resp.json();
    state.catalog = json;
    st.innerHTML = `<span class="success">Catálogo cargado ✓</span> Versión: <b>${json.version||'s/n'}</b>, procedimientos: ${json.procedimientos?.length||0}, guarderías: ${json.guarderias?.length||0}`;
    await idbSet('catalog', json);
    populateGuarderias(); populateFilters();
    setHeaderEnabled(true);
    $('#navSection').classList.add('hidden');
    $('#puntosSection').classList.add('hidden'); $('#resumenSection').classList.add('hidden');
  }catch(err){ st.innerHTML = `<span class="danger">Error al cargar catálogo:</span> ${err.message}`; }
}
async function loadCatalogFromFile(file){
  const st = $('#catalogStatus');
  try{
    const text = await file.text(); const json = JSON.parse(text);
    state.catalog = json;
    st.innerHTML = `<span class="success">Catálogo importado ✓</span> Versión: <b>${json.version||'s/n'}</b>`;
    await idbSet('catalog', json);
    populateGuarderias(); populateFilters();
    setHeaderEnabled(true);
  }catch(err){ st.innerHTML = `<span class="danger">Error al leer JSON:</span> ${err.message}`; }
}

/*** Guarderías / cabecera ***/
function populateGuarderias(){
  const sel = $('#selGuarderia'); sel.innerHTML = '';
  const guards = (state.catalog?.guarderias)||[];
  if(!guards.length){
    const o = document.createElement('option'); o.value=''; o.textContent='— Carga un catálogo —';
    sel.appendChild(o);
    setHeaderEnabled(false);
    return;
  }
  const opt0 = document.createElement('option'); opt0.value=''; opt0.textContent='Elegir...'; sel.appendChild(opt0);
  for(const g of guards){
    const o = document.createElement('option');
    o.value = g.guarderiaNumero; o.textContent = `${g.guarderiaNumero} – ${g.guarderiaNombre}`;
    o.dataset.ciudad = g.ciudadEstado||''; o.dataset.dir = g.directora||''; sel.appendChild(o);
  }
  setHeaderEnabled(true);
}
function autoCoord(guardNum){
  const asign = (state.catalog?.asignaciones)||[];
  const hit = asign.find(a=> String(a.guarderiaNumero).trim()===String(guardNum).trim());
  if(hit){ $('#inpCoord').value = hit.coordinadora; }
}
$('#selGuarderia').addEventListener('change', e=>{
  const opt = e.target.selectedOptions[0]; if(!opt) return;
  $('#inpCoord').placeholder = 'Nombre de coordinadora'; autoCoord(opt.value);
});
$('#findGuard').addEventListener('input', e=>{
  const t = e.target.value.trim().toLowerCase();
  const sel = $('#selGuarderia'); const opts = Array.from(sel.options);
  for(const o of opts){ if(!o.value) continue;
    const hay = o.value.toLowerCase().includes(t) || o.textContent.toLowerCase().includes(t);
    o.hidden = !hay;
  }
});

/*** GPS ***/
$('#btnGPS').addEventListener('click', ()=>{
  const el = $('#gpsStatus'); if(!navigator.geolocation){ el.textContent='GPS no disponible'; return; }
  el.textContent = 'Obteniendo ubicación...';
  navigator.geolocation.getCurrentPosition(
    p=>{ const {latitude, longitude, accuracy} = p.coords;
      state.current.gps = {lat:+latitude.toFixed(6), lon:+longitude.toFixed(6), acc:Math.round(accuracy||0)};
      el.innerHTML = `Lat: <b>${state.current.gps.lat}</b>, Lon: <b>${state.current.gps.lon}</b>, ±${state.current.gps.acc}m`; autosave();
    },
    err=>{ el.textContent = 'No se pudo obtener ubicación: '+err.message; },
    {enableHighAccuracy:true, timeout:10000}
  );
});

/*** Iniciar / Continuar ***/
$('#btnStart').addEventListener('click', ()=>{
  const sel = $('#selGuarderia'); const opt = sel.selectedOptions[0];
  ensure(state.catalog, 'Debes cargar un catálogo primero.');
  ensure(opt && opt.value, 'Elige una guardería.');
  const coord = $('#inpCoord').value.trim(); ensure(coord, 'Escribe el nombre de la coordinadora.');
  const tipo = $('#selTipo').value; ensure(tipo, 'Elige el tipo de supervisión.');
  const inicio = $('#dtInicio').value; const fin = $('#dtFin').value;
  ensure(inicio, 'Captura fecha/hora de inicio.'); ensure(fin, 'Captura fecha/hora de fin.');
  if(new Date(fin) < new Date(inicio)){ alert('La fecha/hora de fin debe ser mayor o igual al inicio.'); return; }

  const gnum = opt.value;

  // Reinicio automático si cambia la guardería
  const prevGuard = state.current.guarderiaNumero;
  if (prevGuard && prevGuard !== gnum) {
    state.respuestas = {};
    state.finalizadosMedible = {};
    state.evidCount = 0;
    state.shareZipBlob = null;
    state.current.id = ''; // fuerza un nuevo ID
  }

  state.current.guarderiaNumero = gnum;
  state.current.guarderiaNombre = opt.textContent.split(' – ').slice(1).join(' – ');
  state.current.ciudadEstado = opt.dataset.ciudad||'';
  state.current.directora = opt.dataset.dir||'';
  state.current.coordinadora = coord; state.current.tipo = tipo;
  state.current.inicio = inicio; state.current.fin = fin;
  state.current.catalogoVersion = state.catalog?.version||'s/n';
  if(!state.current.id) state.current.id = `SUP-${gnum}-${todayStr()}-${uid(4)}`;
  autosave();

  $('#navSection').classList.remove('hidden');
  $('#puntosSection').classList.remove('hidden');
  $('#resumenSection').classList.add('hidden');
  populateFilters(); listPuntos();
});

/*** Filtros (IDs) ***/
function catPuntos(){
  const out = [];
  const procs = state.catalog?.procedimientos||[];
  for(const proc of procs){
    for(const pr of (proc.procesos||[])){
      for(const es of (pr.elementosEstandar||[])){
        for(const em of (es.elementosMedibles||[])){
          for(const p of (em.puntos||[])){
            out.push({
              ...p,
              procedimientoId: proc.id, procedimiento: proc.nombre,
              procesoId: pr.id,         proceso: pr.nombre,
              estandarId: es.id,        elementoEstandar: es.nombre,
              medibleId: em.id,         elementoMedible: em.nombre
            });
          }
        }
      }
    }
  }
  return out;
}
function computeStatuses(){
  const pts = catPuntos(); const resp = state.respuestas; const finz = state.finalizadosMedible || {};
  const byMedible = {};
  for(const p of pts){
    const key = p.medibleId;
    byMedible[key] = byMedible[key] || {
      total:0, answered:0,
      procId:p.procesoId, procName:p.proceso,
      estId:p.estandarId, estName:p.elementoEstandar,
      medName:p.elementoMedible,
      procParent:p.procedimientoId, procParentName:p.procedimiento,
      finalizado: !!finz[key]
    };
    byMedible[key].total++;
    const r = resp[p.id]; if(r && (r.cumple===true || r.cumple===false)) byMedible[key].answered++;
  }
  const byEstandar = {}, byProceso = {}, byProc = {};
  for(const [, m] of Object.entries(byMedible)){
    (byEstandar[m.estId] = byEstandar[m.estId] || {medibles:[], name:m.estName, procId:m.procId, procParent:m.procParent, procParentName:m.procParentName}).medibles.push(m);
    (byProceso[m.procId]  = byProceso[m.procId]  || {medibles:[], name:m.procName, procParent:m.procParent, procParentName:m.procParentName}).medibles.push(m);
    (byProc[m.procParent] = byProc[m.procParent] || {medibles:[], name:m.procParentName}).medibles.push(m);
  }
  return {byMedible, byEstandar, byProceso, byProc};
}
function statusMedible(m){ if(m.finalizado) return '🟢'; if(m.answered<=0) return '⚪'; return '🟡'; }
function statusGroup(medibles){ if(!medibles?.length) return '⚪'; const allGreen=medibles.every(m=>m.finalizado); if(allGreen) return '🟢'; const any=medibles.some(m=>m.answered>0||m.finalizado); return any?'🟡':'⚪'; }

function populateFilters(){
  const puntos = catPuntos();
  const {byMedible, byEstandar, byProceso, byProc} = computeStatuses();

  const fP = $('#fProced'), fPr = $('#fProceso'), fEs = $('#fEstandar'), fEm = $('#fMedible');

  const selOpt = (el, vals, ph, decorateFn)=>{
    const keep = el.value; el.innerHTML = '';
    const o0 = document.createElement('option'); o0.value=''; o0.textContent = ph; el.appendChild(o0);
    for(const v of vals){
      const o=document.createElement('option');
      o.value = v.id; o.textContent = decorateFn? decorateFn(v) : (v.label || v.id);
      el.appendChild(o);
    }
    el.value = keep||''; if(!Array.from(el.options).some(o=>o.value===el.value)) el.value='';
  };

  // Procedimiento
  const procIds = {}; for(const p of puntos){ procIds[p.procedimientoId]=p.procedimiento; }
  const procArr = Object.entries(procIds).map(([id,name])=> ({id, label:name}));
  selOpt(fP, procArr, 'Todos los procedimientos', (v)=>{ const s = byProc[v.id]; const em = s? statusGroup(s.medibles):'⚪'; return `${em} ${v.label}`; });

  // Proceso
  const fp = fP.value;
  const procFilter = puntos.filter(p=>!fp || p.procedimientoId===fp);
  const proIds = {}; for(const p of procFilter){ proIds[p.procesoId]=p.proceso; }
  const proArr = Object.entries(proIds).map(([id,name])=> ({id, label:name}));
  selOpt(fPr, proArr, 'Todos los procesos', (v)=>{ const s = byProceso[v.id]; const em = s? statusGroup(s.medibles):'⚪'; return `${em} ${v.label}`; });

  // Estándar
  const fpr = fPr.value;
  const estFilter = procFilter.filter(p=>!fpr || p.procesoId===fpr);
  const esIds = {}; for(const p of estFilter){ esIds[p.estandarId]=p.elementoEstandar; }
  const esArr = Object.entries(esIds).map(([id,name])=> ({id, label:name}));
  selOpt(fEs, esArr, 'Todos los elementos estándar', (v)=>{ const s = byEstandar[v.id]; const em = s? statusGroup(s.medibles):'⚪'; return `${em} ${v.label}`; });

  // Medible
  const fes = fEs.value;
  const medFilter = estFilter.filter(p=>!fes || p.estandarId===fes);
  const emIds = {}; for(const p of medFilter){ emIds[p.medibleId]=p.elementoMedible; }
  const emArr = Object.entries(emIds).map(([id,name])=> ({id, label:name}));
  selOpt(fEm, emArr, 'Todos los elementos medibles', (v)=>{ const s = byMedible[v.id]; const em = s? statusMedible(s):'⚪'; return `${em} ${v.label}`; });

  [fP,fPr,fEs,fEm].forEach(el=> el.onchange = ()=>{ populateFilters(); listPuntos(); });

  const total = puntos.length;
  $('#statsFiltros').textContent = `Total puntos catálogo: ${fmt(total)}. Usa los filtros o navega por semáforos.`;
  updateFinalizeButton();
}

// Búsqueda por número
$('#btnIrPunto').addEventListener('click', goToPointByNumber);
$('#searchPunto').addEventListener('keyup', (e)=>{ if(e.key==='Enter') goToPointByNumber(); });
function goToPointByNumber(){
  const n = parseInt($('#searchPunto').value.trim(),10);
  if(!n){ alert('Escribe un número de punto (ej. 165)'); return; }
  const all = catPuntos(); const p = all.find(x=> Number(x.numero)===n);
  if(!p){ alert(`No encontré el punto #${n} en el catálogo.`); return; }
  selectPathForPoint(p); listPuntos(null,false,p.id); ensurePuntosVisible();
}
function selectPathForPoint(p){
  const fP=$('#fProced'), fPr=$('#fProceso'), fEs=$('#fEstandar'), fEm=$('#fMedible');
  fP.value = p.procedimientoId; populateFilters();
  fPr.value = p.procesoId;       populateFilters();
  fEs.value = p.estandarId;      populateFilters();
  fEm.value = p.medibleId;       populateFilters();
}

function getPointsOfSelectedMedible(){
  const fem = $('#fMedible').value;
  if(!fem) return {medibleId:null, puntos:[]};
  const all = catPuntos();
  const puntos = all.filter(p=> p.medibleId===fem);
  const medibleId = fem;
  return {medibleId, puntos};
}
function updateFinalizeButton(){
  const btn = $('#btnFinalizarMedible');
  const fem = $('#fMedible').value;
  if(!fem){ btn.classList.add('hidden'); return; }
  const {medibleId} = getPointsOfSelectedMedible();
  if(!medibleId){ btn.classList.add('hidden'); return; }
  const fin = !!state.finalizadosMedible[medibleId];
  if(fin){ btn.textContent='Reabrir elemento medible'; btn.classList.remove('ok'); btn.classList.add('bad'); }
  else{ btn.textContent='Finalizar elemento medible'; btn.classList.remove('bad'); btn.classList.add('ok'); }
  btn.classList.remove('hidden');
}
$('#btnFinalizarMedible').addEventListener('click', ()=>{
  const {medibleId, puntos} = getPointsOfSelectedMedible();
  if(!medibleId) return;
  const fin = !!state.finalizadosMedible[medibleId];
  if(fin){ delete state.finalizadosMedible[medibleId]; autosave(); populateFilters(); listPuntos(); return; }
  let pend=0; for(const p of puntos){ const r=state.respuestas[p.id]; if(!(r && (r.cumple===true || r.cumple===false))) pend++; }
  if(pend>0 && !confirm(`Hay ${pend} punto(s) sin respuesta en este Elemento Medible.\n¿Deseas finalizar de todas formas?`)) return;
  state.finalizadosMedible[medibleId] = true; autosave(); populateFilters(); listPuntos();
});

// Reiniciar solo semáforos (no toca resultados)
$('#btnResetSemaforos').addEventListener('click', ()=>{
  if(!confirm('Esto reiniciará los semáforos (finalizaciones) de esta supervisión.\nNo afecta los resultados de los puntos.\n¿Continuar?')) return;
  state.finalizadosMedible = {};
  autosave();
  populateFilters();
});

/*** Lista ***/
function getFilteredPuntos(customFilter=null, ignoreFilters=false){
  const puntos = catPuntos();
  if(ignoreFilters){ return puntos.filter(p=> (customFilter? customFilter(p): true)); }
  const fp=$('#fProced').value, fpr=$('#fProceso').value, fes=$('#fEstandar').value, fem=$('#fMedible').value;
  const byFilt = p =>
    (!fp  || p.procedimientoId===fp) &&
    (!fpr || p.procesoId===fpr) &&
    (!fes || p.estandarId===fes) &&
    (!fem || p.medibleId===fem);
  return puntos.filter(p=> (customFilter? customFilter(p): true) && byFilt(p));
}
function listPuntos(customFilter=null, ignoreFilters=false, highlightId=null){
  const cont = $('#listaPuntos'); cont.innerHTML='';
  const pts = getFilteredPuntos(customFilter, ignoreFilters);
  $('#countPuntos').textContent = `${fmt(pts.length)} punto(s) mostrados.`; ensurePuntosVisible();
  if(pts.length===0){ const emp=document.createElement('div'); emp.className='small muted'; emp.textContent='No hay puntos para los filtros actuales.'; cont.appendChild(emp); return; }
  for(const p of pts){
    const ans = state.respuestas[p.id] || {cumple:true, detalle:"", accion:"", evidencias:[]};
    const it = document.createElement('div'); it.className='item'; it.id = `row-${p.id}`;
    it.innerHTML = `
      <div class="flex">
        <h4>#${p.numero} — ${p.descripcion || p.Descripción || p.descripcion_punto || p.desc || '(sin descripción)'}</h4>
        <span class="right tag">${p.nivelRiesgo||'riesgo s/d'}</span>
      </div>
      <div class="small muted">${p.procedimiento} › ${p.proceso} › ${p.elementoEstandar} › <b>${p.elementoMedible}</b></div>
      <div class="row" style="margin-top:6px">
        <div class="col">
          <label class="small">Resultado</label>
          <div class="flex">
            <button class="ok" data-act="cumple" data-id="${p.id}" style="width:auto">Cumple</button>
            <button class="bad" data-act="nocumple" data-id="${p.id}" style="width:auto">No cumple</button>
            <span class="small muted" id="st-${p.id}" style="margin-left:8px"></span>
          </div>
        </div>
        <div class="col" style="align-self:flex-end;text-align:right">
          <button class="ghost" data-act="editar" data-id="${p.id}" style="width:auto">Detalle / Evidencias</button>
        </div>
      </div>
      <div class="small" id="mini-${p.id}" style="margin-top:6px;color:${ans.cumple?'var(--muted)':'var(--bad)'}">
        ${ans.cumple ? 'Cumple' : 'No cumple'}${!ans.cumple && (ans.detalle||ans.accion)? ' — '+ [ans.detalle, ans.accion].filter(Boolean).join(' | ').slice(0,160)+'...' : ''}${ans.evidencias?.length? ` — Evidencias: ${ans.evidencias.length}`:''}
      </div>
    `;
    cont.appendChild(it);
  }
  cont.querySelectorAll('button[data-act]').forEach(btn=> btn.onclick = ()=> handlePuntoAction(btn.dataset.act, btn.dataset.id));
  if(highlightId){ const el = document.getElementById(`row-${highlightId}`); if(el){ el.classList.add('flash'); el.scrollIntoView({behavior:'smooth', block:'center'}); setTimeout(()=>el.classList.remove('flash'), 1700); } }
}
$('#btnAllCumple').addEventListener('click', ()=>{
  const fem = $('#fMedible').value; if(!fem){ alert('Primero elige un “Elemento Medible”.'); return; }
  const pts = getFilteredPuntos();
  for(const p of pts){ if(!state.respuestas[p.id]) state.respuestas[p.id] = {cumple:true, detalle:"", accion:"", evidencias:[]}; else state.respuestas[p.id].cumple = true; }
  autosave(); listPuntos();
});

function handlePuntoAction(act, id){
  if(act==='cumple'){
    if(!state.respuestas[id]) state.respuestas[id]={cumple:true, detalle:"", accion:"", evidencias:[]};
    state.respuestas[id].cumple = true; autosave(); listPuntos();
  }else if(act==='nocumple'){
    if(!state.respuestas[id]) state.respuestas[id]={cumple:false, detalle:"", accion:"", evidencias:[]};
    state.respuestas[id].cumple = false;
    const p = catPuntos().find(x=>x.id===id);
    if(p){
      const r = state.respuestas[id];
      const baseDet = p.baseDetalle || '';
      const baseAcc = p.baseAccion  || '';
      // Orígenes: guardamos una sola vez (plantilla original con placeholders si existen)
      if(!r._origDetalle) r._origDetalle = baseDet || '{motivo}';
      if(!r._origAccion)  r._origAccion  = baseAcc || '{accion}';
      // Primera vez, prellenar con la plantilla original (no concatenar)
      if(!r.detalle) r.detalle = r._origDetalle;
      if(!r.accion)  r.accion  = r._origAccion;
    }
    autosave(); listPuntos();
  }else if(act==='editar'){ openDlgPunto(id); }
}

/*** Modal punto + variantes ***/
let dlgPointId = null;

function openDlgPunto(id){
  const p = catPuntos().find(x=>x.id===id); if(!p) return;
  const r = state.respuestas[id] || (state.respuestas[id]={cumple:true, detalle:"", accion:"", evidencias:[]});
  dlgPointId = id;
  const desc = p.descripcion || p.Descripción || p.descripcion_punto || p.desc || '(sin descripción)';
  $('#dlgTitle').textContent = `Punto #${p.numero} — ${desc}`;
  $('#dlgMeta').textContent = `${p.procedimiento} › ${p.proceso} › ${p.elementoEstandar} › ${p.elementoMedible}`;

  const baseDet = p.baseDetalle || '';
  const baseAcc = p.baseAccion  || '';

  // Origen fijo por punto (plantilla original con placeholders si existen)
  if(!r._origDetalle) r._origDetalle = baseDet || '{motivo}';
  if(!r._origAccion)  r._origAccion  = baseAcc || '{accion}';

  // Mostrar valores actuales (si no hay, usar origen)
  $('#dlgDetalle').value = r.detalle || r._origDetalle;
  $('#dlgAccion').value  = r.accion  || r._origAccion;

  // Mostrar panel de variantes si hay placeholders en origen o si existen variantes
  const varsBox = $('#dlgVars');
  const hasMotivoPH = /\{motivo\}/i.test(r._origDetalle) || /\{motivo\}/i.test(r._origAccion);
  const hasAccionPH = /\{accion\}/i.test(r._origDetalle) || /\{accion\}/i.test(r._origAccion);
  const hasVariants = (p.variantesDetalle?.length || p.variantesAccion?.length);
  if(hasMotivoPH || hasAccionPH || hasVariants) varsBox.classList.remove('hidden'); else varsBox.classList.add('hidden');

  // Poblar selects (no tocamos los inputs)
  const selMot = $('#dlgMotivoSel'), selAcc = $('#dlgAccionSel');
  function fillSelect(sel, arr, ph){
    sel.innerHTML = '';
    const o0 = document.createElement('option'); o0.value=''; o0.textContent = ph; sel.appendChild(o0);
    (arr||[]).forEach((v,i)=>{
      const o = document.createElement('option');
      o.value = String(i);
      o.textContent = v.tituloCorto || `(Variante ${i+1})`;
      sel.appendChild(o);
    });
  }
  fillSelect(selMot, p.variantesDetalle, '— Elegir motivo —');
  fillSelect(selAcc, p.variantesAccion,  '— Elegir acción —');

  // Inputs en blanco (NO autollenar al cambiar select)
  $('#dlgMotivo').value    = ''; // r.vars?.motivo no se inyecta; se escribe manualmente si se quiere
  $('#dlgAccionVar').value = '';

  // Vista previa
  function openPreview(title, text){
    const dlg = $('#dlgPreview');
    $('#pvTitle').textContent = title;
    $('#pvBody').textContent = text || '(sin texto)';
    dlg.showModal();
    $('#pvClose').onclick = ()=> dlg.close();
  }
  $('#btnVerMotivo').onclick = (ev)=>{
    ev.preventDefault();
    const idx = +selMot.value;
    const v = (p.variantesDetalle||[])[idx];
    openPreview('Vista previa de motivo', (v?.texto||'').trim());
  };
  $('#btnVerAccion').onclick = (ev)=>{
    ev.preventDefault();
    const idx = +selAcc.value;
    const v = (p.variantesAccion||[])[idx];
    openPreview('Vista previa de acción', (v?.texto||'').trim());
  };

  // Aplicar SIEMPRE desde la plantilla original, tantas veces como quieras
  $('#btnAplicarVars').onclick = (ev)=>{
    ev.preventDefault();

    // Decidir textos a usar: manual si el input NO está vacío; si vacío, usar seleccionado del combo; si ambos vacíos, no cambiar ese lado
    let motivoTxt = $('#dlgMotivo').value.trim();
    let accionTxt = $('#dlgAccionVar').value.trim();

    let motivoFuente = null, accionFuente = null;

    if(!motivoTxt){
      const idxM = +selMot.value;
      const vM = (p.variantesDetalle||[])[idxM];
      if(vM?.texto) { motivoTxt = vM.texto.trim(); motivoFuente = 'dropdown'; }
    } else { motivoFuente = 'manual'; }

    if(!accionTxt){
      const idxA = +selAcc.value;
      const vA = (p.variantesAccion||[])[idxA];
      if(vA?.texto) { accionTxt = vA.texto.trim(); accionFuente = 'dropdown'; }
    } else { accionFuente = 'manual'; }

    // Construir desde el ORIGEN (no desde lo que hay escrito)
    let detTxt = r._origDetalle || '';
    let accTxt = r._origAccion  || '';

    // Reemplazo si hay placeholders, si no hay: concatenar con espacio (si existe texto)
    if(/\{motivo\}/i.test(detTxt) || /\{accion\}/i.test(detTxt)){
      detTxt = replacePlaceholders(detTxt, {motivo: motivoTxt||'', accion: accionTxt||''});
    }else{
      if(motivoTxt) detTxt = (detTxt+' '+motivoTxt).replace(/\s+\./g,'.').trim();
      if(!detTxt.endsWith('.')) detTxt += '.';
    }
    if(/\{motivo\}/i.test(accTxt) || /\{accion\}/i.test(accTxt)){
      accTxt = replacePlaceholders(accTxt, {motivo: motivoTxt||'', accion: accionTxt||''});
    }else{
      if(accionTxt) accTxt = (accTxt+' '+accionTxt).replace(/\s+\./g,'.').trim();
      if(!accTxt.endsWith('.')) accTxt += '.';
    }

    // Asignar a UI
    $('#dlgDetalle').value = detTxt.trim();
    $('#dlgAccion').value  = accTxt.trim();

    // Persistir fuentes (solo si se aportó algo)
    r.meta = r.meta || {};
    if(motivoTxt){ r.meta.motivoFuente = motivoFuente || 'dropdown'; r.meta.motivoTexto = motivoTxt; }
    if(accionTxt){ r.meta.accionFuente = accionFuente || 'dropdown'; r.meta.accionTexto = accionTxt; }

    autosave();
  };

  // Restaurar original (limpia selects, inputs y revierte textos)
  $('#btnRestaurarTpl').onclick = (ev)=>{
    ev.preventDefault();
    $('#dlgDetalle').value = r._origDetalle || '';
    $('#dlgAccion').value  = r._origAccion  || '';
    $('#dlgMotivoSel').value = '';
    $('#dlgAccionSel').value  = '';
    $('#dlgMotivo').value = '';
    $('#dlgAccionVar').value = '';
    if(r.meta){ delete r.meta.motivoFuente; delete r.meta.motivoTexto; delete r.meta.accionFuente; delete r.meta.accionTexto; }
    autosave();
  };

  renderDlgPrev(r.evidencias||[]);
  const dlg = $('#dlgPunto'); dlg.showModal();

  const form = dlg.querySelector('form');
  form.onsubmit = ev=>{
    ev.preventDefault();
    if(ev.submitter?.value==='delEvs'){
      r.evidencias = [];
      renderDlgPrev(r.evidencias);
      autosave();
      return;
    }
    // Guardar lo que está en los textareas
    r.detalle = ($('#dlgDetalle').value||'').trim();
    r.accion  = ($('#dlgAccion').value||'').trim();
    autosave();
    dlg.close();
    listPuntos();
  };

  $('#dlgFile').onchange = async (e)=>{
    const files = Array.from(e.target.files||[]); if(!files.length) return;
    for(const f of files){ const ev = await compressImageFile(f, 1600, 0.75); r.evidencias.push(ev); state.evidCount++; }
    e.target.value = ''; renderDlgPrev(r.evidencias); autosave();
  };
}

function renderDlgPrev(list){
  const prev = $('#dlgPrev'); prev.innerHTML=''; if(!list?.length){ prev.textContent='No hay evidencias.'; return; }
  for(const ev of list){
    const url = URL.createObjectURL(ev.blob);
    const a = document.createElement('a'); a.href=url; a.target='_blank'; a.textContent=ev.name+` (${ev.width}x${ev.height})`;
    a.className='pill'; prev.appendChild(a);
  }
}
function loadImage(file){ return new Promise((res,rej)=>{ const fr=new FileReader();
  fr.onload=()=>{ const img=new Image(); img.onload=()=>res(img); img.onerror=rej; img.src=fr.result; };
  fr.onerror=rej; fr.readAsDataURL(file); });}
async function compressImageFile(file, maxSize=1600, quality=0.75){
  const img = await loadImage(file);
  const w=img.width, h=img.height; let nw=w, nh=h;
  if(Math.max(w,h)>maxSize){ if(w>h){ nw=maxSize; nh=Math.round(h*(maxSize/w)); } else { nh=maxSize; nw=Math.round(w*(maxSize/h)); } }
  const cv=document.createElement('canvas'); cv.width=nw; cv.height=nh; const cx=cv.getContext('2d'); cx.drawImage(img,0,0,nw,nh);
  const blob = await new Promise(res=> cv.toBlob(res,'image/jpeg',quality));
  const name = `p${dlgPointId||'x'}_${Date.now()}_${uid(3)}.jpg`;
  return {name, blob, width:nw, height:nh};
}

/*** Autosave ***/
let autosaveTimer=null;
function autosave(){
  if(autosaveTimer) clearTimeout(autosaveTimer);
  autosaveTimer = setTimeout(async ()=>{
    await idbSet('current', state.current);
    await idbSet('respuestas', state.respuestas);
    await idbSet('finalizados', state.finalizadosMedible);
    const es = document.getElementById('exportStatus'); if(es) es.textContent = 'Progreso guardado.';
  }, 300);
}
async function restoreIfAny(){
  await idbOpen();
  const cat = await idbGet('catalog');
  if(cat){
    state.catalog=cat; populateGuarderias(); populateFilters(); setHeaderEnabled(true);
  }else{
    setHeaderEnabled(false);
    const adminPanel = $('#adminPanel');
    adminPanel.classList.remove('hidden');
    $('#btnToggleAdmin').textContent = 'Ocultar herramientas de administrador';
    const al = document.getElementById('alertNoCatalog'); al.classList.remove('hidden');
    adminPanel.scrollIntoView({behavior:'smooth', block:'start'});
  }
  const cur = await idbGet('current'); if(cur){ state.current=cur; fillHeader(cur); }
  const resp = await idbGet('respuestas'); if(resp){ state.respuestas=resp; }
  const finz = await idbGet('finalizados'); if(finz){ state.finalizadosMedible = finz; }
}
function fillHeader(c){
  if(!c) return;
  const sel = $('#selGuarderia');
  const opt = Array.from(sel.options).find(o=>o.value===c.guarderiaNumero);
  if(opt) sel.value = c.guarderiaNumero;
  $('#inpCoord').value = c.coordinadora||'';
  $('#selTipo').value = c.tipo||'';
  $('#dtInicio').value = c.inicio||'';
  $('#dtFin').value = c.fin||'';
  if(c.gps){ $('#gpsStatus').innerHTML = `Lat: <b>${c.gps.lat}</b>, Lon: <b>${c.gps.lon}</b>, ±${c.gps.acc}m`; }
}

/*** Resumen & export ***/
$('#btnResumen').addEventListener('click', ()=>{
  const puntos = catPuntos();
  const total = puntos.length; let nc=0, evs=0;
  for(const p of puntos){ const r = state.respuestas[p.id]; if(r){ if(r.cumple===false) nc++; evs += (r.evidencias?.length||0); } }
  const mins = Math.max(0, Math.round((+new Date(state.current.fin) - +new Date(state.current.inicio))/60000));
  const rd = $('#resumenData'); rd.innerHTML = `
    <div class="grid cols3">
      <div class="card"><div class="muted small">Guardería</div><div><b>${state.current.guarderiaNumero}</b> — ${state.current.guarderiaNombre}</div></div>
      <div class="card"><div class="muted small">Coordinadora</div><div>${state.current.coordinadora}</div></div>
      <div class="card"><div class="muted small">Tipo</div><div>${state.current.tipo}</div></div>
    </div>
    <div class="grid cols3">
      <div class="card"><div class="muted small">Inicio</div><div>${state.current.inicio||'-'}</div></div>
      <div class="card"><div class="muted small">Fin</div><div>${state.current.fin||'-'}</div></div>
      <div class="card"><div class="muted small">Duración</div><div>${mins} min</div></div>
    </div>
    <div class="grid cols3">
      <div class="card"><div class="muted small">Catálogo versión</div><div>${state.current.catalogoVersion}</div></div>
      <div class="card"><div class="muted small">Puntos (total)</div><div>${total}</div></div>
      <div class="card"><div class="muted small">No conformidades</div><div class="danger"><b>${nc}</b></div></div>
    </div>
    <div class="grid cols3">
      <div class="card"><div class="muted small">Evidencias agregadas</div><div>${evs}</div></div>
      <div class="card"><div class="muted small">ID de supervisión</div><div class="mono">${state.current.id}</div></div>
      <div class="card"><div class="muted small">Ubicación</div><div>${state.current.gps? ('Lat '+state.current.gps.lat+', Lon '+state.current.gps.lon): 'No capturada'}</div></div>
    </div>
  `;
  $('#resumenSection').classList.remove('hidden');
  window.scrollTo({top: document.body.scrollHeight, behavior:'smooth'});
});
$('#btnExport').addEventListener('click', async ()=>{
  try{ const {zipBlob, fileName} = await buildZip(); downloadBlob(zipBlob, fileName); state.shareZipBlob = zipBlob;
    $('#exportStatus').innerHTML = `<span class="success">ZIP generado:</span> ${fileName}`; }
  catch(err){ $('#exportStatus').innerHTML = `<span class="danger">Error exportando:</span> ${err.message}`; }
});
$('#btnShare').addEventListener('click', async ()=>{
  if(!navigator.canShare || !state.shareZipBlob){ alert('Primero exporta el ZIP.'); return; }
  try{ const fileName = genFileName(); const file = new File([state.shareZipBlob], fileName, {type:'application/zip'});
    await navigator.share({title:'Supervisión', text:'Envio supervisión', files:[file]}); } catch(e){ console.log('Share cancel/err', e); }
});
function genFileName(){ const g = state.current.guarderiaNumero||'G'; return `supervision_${g}_${todayStr()}_v1.zip`; }
async function buildZip(){
  const enc = new TextEncoder(); const json = buildDatosJSON();
  const jsonBytes = enc.encode(JSON.stringify(json, null, 2));
  const csvBytes  = enc.encode(buildCSV(json));
  const suggText  = buildPlantillasCSV(json);
  const manualCSV = buildManualNewCSV(json);
  const files = [ {name:'datos.json', data: jsonBytes}, {name:'datos.csv', data: csvBytes} ];
  if(suggText){ files.push({name:'plantillas_sugeridas.csv', data: enc.encode(suggText)}); }
  if(manualCSV){ files.push({name:'nuevos_motivos_acciones.csv', data: enc.encode(manualCSV)}); }
  for(const r of Object.values(state.respuestas)){ for(const ev of (r.evidencias||[])){ const buf = await ev.blob.arrayBuffer(); files.push({name:`evidencias/${ev.name}`, data: new Uint8Array(buf)}); } }
  const zipBlob = zipStore(files); return {zipBlob, fileName: genFileName()};
}
function buildDatosJSON(){
  const respuestas = Object.entries(state.respuestas).map(([pid,r])=>{
    const p = catPuntos().find(x=>x.id===pid);
    return {
      puntoId: pid, numero: p?.numero ?? null,
      descripcion: p?.descripcion ?? '',
      procedimiento: p?.procedimiento ?? '', proceso: p?.proceso ?? '',
      elementoEstandar: p?.elementoEstandar ?? '', elementoMedible: p?.elementoMedible ?? '',
      nivelRiesgo: p?.nivelRiesgo ?? '',
      cumple: r.cumple!==false,
      detalle: r.detalle||'',
      accion:  r.accion||'',
      origenDetalle: r._origDetalle || '',
      origenAccion:  r._origAccion  || '',
      meta: r.meta || {},
      evidencias: (r.evidencias||[]).map(ev=> `evidencias/${ev.name}`)
    };
  });
  return {
    guarderiaId: state.current.guarderiaNumero, guarderiaNombre: state.current.guarderiaNombre,
    ciudadEstado: state.current.ciudadEstado, directora: state.current.directora,
    fecha: new Date().toISOString(), catalogoVersion: state.current.catalogoVersion,
    responsable: state.current.coordinadora, tipo: state.current.tipo,
    inicio: state.current.inicio, fin: state.current.fin,
    duracionMin: Math.max(0, Math.round((+new Date(state.current.fin) - +new Date(state.current.inicio))/60000)),
    gps: state.current.gps || null, supervisionId: state.current.id,
    totalPuntos: catPuntos().length,
    resumen: buildResumen(),
    respuestas
  };
}
function buildResumen(){
  const puntos = catPuntos(); let nc=0, porProc={};
  for(const p of puntos){
    const r = state.respuestas[p.id]; const cumple = r? (r.cumple!==false) : true;
    if(!cumple) nc++; const k = p.procedimiento||'s/d';
    if(!porProc[k]) porProc[k]={nc:0,total:0}; porProc[k].total++; if(!cumple) porProc[k].nc++;
  }
  return {noConformidades: nc, porProcedimiento: porProc};
}
function buildCSV(json){
  const head = [
    'Guarderia_Numero','Guarderia_Nombre','Ciudad_Estado','Directora','Coordinadora','Tipo_Supervision',
    'FechaHora_Inicio','FechaHora_Fin','Duracion_Minutos','Catalogo_Version',
    'ID_Control','Numero','Procedimiento','Proceso','Elemento_Estandar','Elemento_Medible','Nivel_Riesgo','Descripcion',
    'Cumple','Detalle_Incumplimiento','Accion_Tomada','Evidencias',
    'Motivo_Fuente','Accion_Fuente','Motivo_Texto','Accion_Texto'
  ];
  const rows = [toCSVRow(head)];
  for(const r of json.respuestas){
    rows.push(toCSVRow([
      json.guarderiaId, json.guarderiaNombre, json.ciudadEstado, json.directora, json.responsable, json.tipo,
      json.inicio, json.fin, json.duracionMin, json.catalogoVersion,
      r.puntoId, r.numero, r.procedimiento, r.proceso, r.elementoEstandar, r.elementoMedible, r.nivelRiesgo, r.descripcion,
      r.cumple ? 'TRUE' : 'FALSE', r.detalle, r.accion, (r.evidencias||[]).join(' | '),
      r.meta?.motivoFuente||'', r.meta?.accionFuente||'', r.meta?.motivoTexto||'', r.meta?.accionTexto||'',
    ]));
  }
  return rows.join('\n');
}
function buildPlantillasCSV(json){
  const puntos = catPuntos(); const lines = [];
  const head = [
    'Catalogo_Version','ID_Control','Numero_Punto','Procedimiento','Proceso','Elemento_Estandar','Elemento_Medible',
    'Tipo_Texto','Texto_Sugerido','Sugerencia_Origen','Coordinadora','FechaHora','Guarderia_Numero','Guarderia_Nombre','Veces_Usado'
  ];
  lines.push(toCSVRow(head)); let any=false; const usedMap = {};
  for(const r of json.respuestas){
    const p = puntos.find(x=>x.id===r.puntoId); if(!p) continue;
    if(r.detalle && r.detalle.trim()){
      const origen = r.meta?.motivoFuente || '';
      const key = `${p.id}|Detalle|${r.detalle.trim()}|${origen}`;
      usedMap[key]=(usedMap[key]||0)+1;
    }
    if(r.accion && r.accion.trim()){
      const origen = r.meta?.accionFuente || '';
      const key = `${p.id}|Accion|${r.accion.trim()}|${origen}`;
      usedMap[key]=(usedMap[key]||0)+1;
    }
  }
  for(const k of Object.keys(usedMap)){
    const [pid, tipo, texto, origen] = k.split('|'); const p = puntos.find(x=>x.id===pid); if(!p) continue;
    lines.push(toCSVRow([
      json.catalogoVersion, p.id, p.numero, p.procedimiento, p.proceso, p.elementoEstandar, p.elementoMedible,
      tipo, texto, origen, json.responsable, json.fecha, json.guarderiaId, json.guarderiaNombre, usedMap[k]
    ])); any=true;
  }
  return any ? lines.join('\n') : null;
}
function buildManualNewCSV(json){
  const puntos = catPuntos(); const lines = [];
  const head = [
    'Catalogo_Version','ID_Control','Numero_Punto','Procedimiento','Proceso','Elemento_Estandar','Elemento_Medible',
    'Tipo','Texto_Manual','Coordinadora','FechaHora','Guarderia_Numero','Guarderia_Nombre'
  ];
  lines.push(toCSVRow(head)); let any=false;
  for(const r of json.respuestas){
    const p = puntos.find(x=>x.id===r.puntoId); if(!p) continue;
    if(r.meta?.motivoFuente==='manual' && r.meta?.motivoTexto){
      lines.push(toCSVRow([ json.catalogoVersion, p.id, p.numero, p.procedimiento, p.proceso, p.elementoEstandar, p.elementoMedible,
        'Motivo', r.meta.motivoTexto, json.responsable, json.fecha, json.guarderiaId, json.guarderiaNombre ])); any=true;
    }
    if(r.meta?.accionFuente==='manual' && r.meta?.accionTexto){
      lines.push(toCSVRow([ json.catalogoVersion, p.id, p.numero, p.procedimiento, p.proceso, p.elementoEstandar, p.elementoMedible,
        'Accion', r.meta.accionTexto, json.responsable, json.fecha, json.guarderiaId, json.guarderiaNombre ])); any=true;
    }
  }
  return any ? lines.join('\n') : null;
}

/*** Conversor CSV tolerante + variantes flexibles ***/
function parseCSV(text){
  const rows = []; let i=0, cur='', inQ=false, row=[];
  while(i<text.length){
    const ch = text[i];
    if(inQ){ if(ch==='"'){ if(text[i+1]==='"'){ cur+='"'; i+=2; continue; } inQ=false; i++; continue; } else { cur+=ch; i++; continue; } }
    else{
      if(ch==='\"'){ inQ=true; i++; continue; }
      if(ch===','){ row.push(cur); cur=''; i++; continue; }
      if(ch==='\n' || ch==='\r'){ if(ch==='\r' && text[i+1]==='\n') i++; row.push(cur); rows.push(row); row=[]; cur=''; i++; continue; }
      cur+=ch; i++; continue;
    }
  }
  if(cur.length>0 || row.length>0){ row.push(cur); rows.push(row); }
  return rows;
}
function buildCatalogFromCSVs(textosCSV, guardsCSV, asigCSV){
  const textos = parseCSV(textosCSV);
  const guards = parseCSV(guardsCSV);
  const asig = parseCSV(asigCSV);

  const norm = s=> String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-zA-Z0-9]+/g,'').toLowerCase();

  // --- Textos ---
  const hT = textos.shift().map(x=>x.trim()); const ixTn = Object.fromEntries(hT.map((k,i)=>[norm(k), i]));
  const getT = (row, cands)=>{ for(const c of cands){ const ix = ixTn[norm(c)]; if(ix!=null) return row[ix]||''; } return ''; };

  const tree = {};
  for(const r of textos){
    const id = (getT(r, ['ID_Control','Id','ID','id','Id_Control'])||'').trim();
    if(!id) continue;
    const numero = Number(getT(r, ['Numero','Número','ID_Control','id_control','id']));
    const descripcion   = getT(r, ['Descripción','Descripcion','Descripción del Punto','Descripcion del Punto','Descripcion_Punto','Descripción_Punto','Descripcion Punto']);
    const procedimiento = getT(r, ['Procedimientos','Procedimiento']);
    const proceso       = getT(r, ['Proceso']);
    const estandar      = getT(r, ['Elemento_Estandar','Elemento Estandar','Estandar']);
    const medible       = getT(r, ['Elemento_Medible','Elemento Medible','Medible']);
    const nivel         = getT(r, ['Nivel_Riesgo','Nivel Riesgo','Riesgo']);

    // Bases
    const baseDetalle = getT(r, ['Base_Detalle','Base Detalle']) || '';
    const baseAccion  = getT(r, ['Base_Accion','Base Accion'])   || '';

    // Variantes flexibles
    function readVariantsFlexible(kind /*'detalle'|'accion'*/){
      const out = [];
      for(let i=1;i<=20;i++){
        const lblIx = ixTn[ norm(`${kind}_V${i}_Label`) ] ?? ixTn[ norm(`${kind} V${i} Label`) ]
                   ?? ixTn[ norm(`${kind}_V${i}_TituloCorto`) ] ?? ixTn[ norm(`${kind} V${i} TituloCorto`) ];
        const txtIx = ixTn[ norm(`${kind}_V${i}_Texto`) ] ?? ixTn[ norm(`${kind} V${i} Texto`) ]
                   ?? ixTn[ norm(`${kind}_V${i}_Text`) ]  ?? ixTn[ norm(`${kind} V${i} Text`) ];
        const tituloCorto = (lblIx!=null ? r[lblIx] : '')?.trim();
        const texto = (txtIx!=null ? r[txtIx] : '')?.trim();
        if(tituloCorto || texto){
          out.push({ tituloCorto: tituloCorto || `Opción ${i}`, texto: texto || '' });
        }
      }
      return out;
    }
    const variantesDetalle = readVariantsFlexible('detalle');
    const variantesAccion  = readVariantsFlexible('accion');

    // Arbol
    (tree[procedimiento] ||= {});
    (tree[procedimiento][proceso] ||= {});
    (tree[procedimiento][proceso][estandar] ||= {});
    (tree[procedimiento][proceso][estandar][medible] ||= []);
    tree[procedimiento][proceso][estandar][medible].push({
      id, numero, descripcion, nivelRiesgo: nivel,
      baseDetalle, baseAccion,
      variantesDetalle, variantesAccion
    });
  }

  const procedimientos = Object.keys(tree).map(proc=>({
    id: 'proc_'+proc.toLowerCase().replace(/\s+/g,'_'),
    nombre: proc,
    procesos: Object.keys(tree[proc]).length ? Object.keys(tree[proc]).map(pr=>({
      id: 'pr_'+[proc,pr].map(s=>s.toLowerCase().replace(/\s+/g,'_')).join('_'),
      nombre: pr,
      elementosEstandar: Object.keys(tree[proc][pr]).map(es=>({
        id:'es_'+[proc,pr,es].map(s=>s.toLowerCase().replace(/\s+/g,'_')).join('_'),
        nombre: es,
        elementosMedibles: Object.keys(tree[proc][pr][es]).map(em=>({
          id:'em_'+[proc,pr,es,em].map(s=>s.toLowerCase().replace(/\s+/g,'_')).join('_'),
          nombre: em,
          puntos: tree[proc][pr][es][em]
        }))
      }))
    })) : []
  }));

  // --- Guarderías ---
  const hG = guards.shift().map(x=>x.trim()); const ixGn = Object.fromEntries(hG.map((k,i)=>[norm(k), i]));
  const getG = (row, cands)=>{ for(const c of cands){ const ix = ixGn[norm(c)]; if(ix!=null) return row[ix]||''; } return ''; };
  const guarderias = guards.map(r=>({
    guarderiaNumero: (getG(r,['Guarderia_Numero','Guardería_Numero','Numero','Número'])||'').trim(),
    guarderiaNombre: getG(r,['Guarderia_Nombre','Guardería_Nombre','Nombre'])||'',
    razonSocial: getG(r,['Guarderia_RazonSocial','Razonsocial','Razon_Social'])||'',
    ciudadEstado: getG(r,['Guarderia_CiudadEstado','CiudadEstado','Ciudad_Estado'])||'',
    directora: getG(r,['Nombre_Directora','Directora'])||''
  })).filter(g=>g.guarderiaNumero);

  // --- Asignaciones ---
  const hA = asig.shift().map(x=>x.trim()); const ixAn = Object.fromEntries(hA.map((k,i)=>[norm(k), i]));
  const getA = (row, cands)=>{ for(const c of cands){ const ix = ixAn[norm(c)]; if(ix!=null) return row[ix]||''; } return ''; };
  const asignaciones = asig.map(r=>({
    coordinadora: getA(r,['Coordinadora'])||'',
    guarderiaNumero: (getA(r,['Guarderia_Numero','Guardería_Numero','Numero','Número'])||'').trim()
  })).filter(a=>a.guarderiaNumero);

  return { version: new Date().toISOString().slice(0,10), procedimientos, guarderias, asignaciones };
}

/*** UI Conversor ***/
let tmpTextosCSV='', tmpGuardsCSV='', tmpAsigCSV='';
$('#csvTextos').addEventListener('change', async e=> tmpTextosCSV = await e.target.files[0]?.text() || '');
$('#csvGuards').addEventListener('change', async e=> tmpGuardsCSV = await e.target.files[0]?.text() || '');
$('#csvAsig').addEventListener('change', async e=> tmpAsigCSV = await e.target.files[0]?.text() || '');
$('#btnBuildJSON').addEventListener('click', ()=>{
  if(!tmpTextosCSV||!tmpGuardsCSV||!tmpAsigCSV){ alert('Sube los tres CSV.'); return; }
  try{ const obj = buildCatalogFromCSVs(tmpTextosCSV, tmpGuardsCSV, tmpAsigCSV); const pretty = JSON.stringify(obj, null, 2); $('#outJSON').value = pretty; }
  catch(err){ alert('Error al generar JSON: '+err.message); }
});
$('#btnDownloadJSON').addEventListener('click', ()=>{
  const text = $('#outJSON').value; if(!text?.trim()){ alert('Primero genera el JSON.'); return; } textFile(text, 'catalogo.json');
});

/*** Eventos iniciales ***/
$('#btnLoadCatalog').onclick = loadCatalogFromUrl;
$('#fileCatalog').onchange = e=>{ const f=e.target.files[0]; if(f) loadCatalogFromFile(f); };
const adminPanel = $('#adminPanel');
$('#btnToggleAdmin').onclick = ()=>{
  adminPanel.classList.toggle('hidden');
  $('#btnToggleAdmin').textContent = adminPanel.classList.contains('hidden')
    ? 'Mostrar herramientas de administrador'
    : 'Ocultar herramientas de administrador';
};
window.addEventListener('DOMContentLoaded', restoreIfAny);
</script>
</body>
</html>
